# [Challenge] RSA CPU Cache Side-Channel

Let's crack a hardware crypto engine. 

Public parameters are:
```python
# RSA public exponent and modulus
e = 65537 # = 2^16 + 1
n=247986593396209875084012131452934099056733647935670515473445992426598899768930823740730826984242067958254605065641483735657759815550540477139432139634638820800423008986789544454729772610227969667760774290284773564029419009020038717859540703507091627999301056310286835600515951248243765130446092120746666876180555284845580231826491442541887612771483752883992273123591778121336015719453085571539280921597192879792417258434207273636582639024556173720065931114200134382018852051071187029307957847828986113074903235247989408426632701126391774984490145343174906256844624326505324922216905289293
```
Flag to decrypt:
```python
# CTF flag to decrypt
flag_enc = 156539305485572699191103505011941122379332151701553059603110690165418795969653170470280711364827383168784090115293778700305550080169460850699540494174149060011762008936085442871933384008015397771403854069510064266983329620117434277066221978735255338346311441103219209899777467779541064732463934404772189243868464339796846862363442127703578646463227851657485689792622948429216331294552860614314283266751264721228761442121952040022067542021305711961849418456816471091404036663730796501797813320194656309206085482726560893004214523505587683373830593170341654010162468594209116725534777579419
```
Leaks through CPU cache lines have revealed some bits of RSA parameters:

```python
# some bits leaked
p_bits  = "?????????????????????????????????????????????????????????????????????????????????????0??????????0??????????1??????????0??????????1????????????????????????????????????????????????????????????????????????????????????????????????1??????????1??????????0??????????1??????????1?????????????????????????????????????????????????????????????????????????????????????1??????????1??????????0??????????0??????????1??????????1?????????????????????????????????????????????????????????????????????????????????????1??????????1??????????0??????????0??????????1??????????0?????????????????????????????????????????????????????????????????????????????????????0??????????1??????????1??????????1??????????1??????????0?????????????????????????????????????????????????????????????????????????????????????0??????????0??????????0??????????1??????????0??????????1?????????????????????????????????????????????????????????????????????????????????????1??????????1??????????1??????????0??????????1??????????1"

q_bits  = "??????????1??????????0?????????????????????????????????????1??????????0??????????0?????????????????????????????????????0??????????0????????????????????????????????????????????????0??????????0????????????????????????????????????????????????0??????????0?????????????????????????????????????1??????????0??????????1?????????????????????????????????????1??????????1????????????????????????????????????????????????1??????????0????????????????????????????????????????????????0??????????0?????????????????????????????????????0??????????0??????????0?????????????????????????????????????1??????????1????????????????????????????????????????????????0??????????1????????????????????????????????????????????????1??????????0?????????????????????????????????????0??????????1??????????0?????????????????????????????????????1??????????1??????????1?????????????????????????????????????0??????????1????????????????????????????????????????????????1??????????1?????????????????????????????????????1"

d_bits  = "??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????0???????????0???????????1???????????0???????????0???????????0???????????0???????????0???????????0???????????0???????????1???????????1???????????1???????????1???????????0???????????0???????????1???????????0???????????0??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????0???????????1???????????1???????????1???????????0???????????0???????????0???????????1???????????0???????????1???????????0???????????1???????????0???????????1???????????1???????????0???????????1???????????0???????????0???????????0??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????0???????????1???????????1???????????0???????????0???????????0???????????0???????????0???????????1???????????1???????????1???????????1???????????0???????????0???????????0???????????1???????????0???????????1???????????0???????????1??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????0???????????1???????????0???????????1???????????1???????????1???????????1???????????0???????????1???????????1???????????1???????????0???????????0???????????0???????????0???????????1???????????1???????????1???????????1???????????1"

dp_bits = "???0??????????????????????????????1???1??????????????????????????????0???1??????????????????????????????1???0??????????????????????????????0???0??????????????????????????????0???1??????????????????????????????0???0??????????????????????????????1???1??????????????????????????????0???1??????????????????????????????0???1??????????????????????????????1???1??????????????????????????????1???0??????????????????????????????0??????????????????????????????????1??????????????????????????????????0??????????????????????????????????0??????????????????????????????????0??????????????????????????????????1??????????????????????????????????1??????????????????????????????????0??????????????????????????????????1??????????????????????????????????1??????????????????????????????????0??????????????????????????????????1??????????????????????????????????0??????????????????????????????????0??????????????????????????????????1??????????????????????????????????0??????????????????????????????1"

dq_bits = "?????????????1??????????????????????????????1?????????????0??????????????????????????????0?????????????1??????????????????????????????1?????????????0??????????????????????????????0?????????????0??????????????????????????????1?????????????0??????????????????????????????0?????????????0??????????????????????????????0?????????????1??????????????????????????????0?????????????0??????????????????????????????1?????????????1??????????????????????????????0?????????????0??????????????????????????????1?????????????1??????????????????????????????1?????????????1??????????????????????????????0?????????????0??????????????????????????????0?????????????1??????????????????????????????0?????????????0??????????????????????????????0?????????????1??????????????????????????????0?????????????1??????????????????????????????1????????????????????????????????????????????0????????????????????????????????????????????0????????????????????????????????????????????0??????????????????????????????1"
```
The following memory access patterns were discovered:
```python
omega = 4 # digit size in bits - amount of bits in a batch of Fixed Window Exonentiation used in Chinese Reminder Theorem

d_p_as_digits=[0, 13, 5, 1, 1, 11, 11, 3, 6, 15, 13, 11, 8, 15, 10, 8, 2, 7, 2, 4, 11, 1, 15, 1, 15, 5, 10, 11, 3, 2, 13, 7, 2, 15, 1, 6, 12, 9, 11, 11, 15, 10, 4, 11, 8, 4, 11, 13, 7, 3, 15, 0, 10, 3, 3, 13, 14, 0, 5, 14, 0, 4, 5, 10, 1, 7, 9, 12, 4, 14, 12, 11, 6, 10, 9, 10, 10, 15, 13, 0, 7, 5, 8, 4, 2, 4, 2, 4, 9, 13, 12, 2, 8, 7, 0, 9, 7, 15, 9, 12, 12, 11, 3, 13, 13, 5, 6, 0, 8, 1, 1, 13, 11, 10, 15, 3, 13, 6, 7, 3, 7, 0, 8, 11, 5, 15, 1, 12, 7, 13, 2, 6, 9, 15, 3, 14, 1, 5, 6, 1, 8, 6, 5, 15, 13, 9, 13, 1, 4, 7, 9, 7, 5, 6, 8, 14, 15, 2, 1, 15, 0, 14, 9, 7, 9, 1, 12, 6, 10, 1, 5, 8, 14, 3, 15, 13, 13, 15, 5, 6, 9, 0, 0, 3, 1, 6, 10, 6, 2, 4, 1, 4, 11, 7, 8, 3, 6, 9, 1, 15, 4, 14, 12, 15, 15, 10, 6, 6, 2, 1, 14, 15, 12, 1, 6, 9, 11, 7, 5, 11, 2, 2, 7, 8, 6, 5, 13, 10, 13, 15, 8, 3, 5, 11, 14, 14, 1, 2, 15, 2, 13, 5, 6, 15]

d_q_as_digits=[13, 10, 13, 0, 0, 3, 6, 2, 6, 4, 15, 9, 15, 2, 10, 12, 15, 3, 4, 2, 2, 10, 10, 11, 3, 11, 9, 7, 14, 12, 5, 10, 6, 11, 8, 2, 2, 8, 3, 11, 0, 4, 6, 0, 0, 1, 11, 4, 9, 2, 8, 14, 12, 14, 15, 14, 12, 8, 9, 9, 9, 6, 5, 1, 2, 12, 10, 6, 7, 2, 6, 12, 13, 13, 2, 12, 15, 15, 8, 12, 0, 15, 14, 4, 14, 8, 6, 15, 13, 12, 5, 2, 12, 10, 12, 10, 9, 7, 10, 4, 3, 0, 0, 6, 0, 7, 10, 6, 7, 5, 5, 15, 8, 12, 11, 14, 0, 2, 11, 5, 7, 4, 10, 3, 8, 5, 5, 14, 3, 12, 1, 6, 6, 8, 0, 0, 1, 9, 8, 14, 15, 12, 10, 8, 3, 2, 14, 5, 6, 1, 3, 8, 5, 13, 3, 1, 14, 6, 9, 1, 11, 0, 7, 12, 12, 11, 14, 0, 14, 15, 9, 6, 10, 7, 9, 10, 5, 12, 12, 3, 10, 11, 7, 9, 13, 10, 1, 11, 11, 4, 13, 10, 13, 14, 13, 6, 1, 3, 6, 12, 3, 5, 5, 2, 2, 7, 12, 11, 2, 3, 9, 8, 14, 0, 5, 7, 12, 10, 14, 8, 3, 10, 2, 6, 4, 12, 9, 7, 2, 4, 4, 15, 0, 4, 11, 14, 5, 7, 4, 0, 4, 9, 11, 13]
```
String encoding utilities:
```python
def string_to_int(s):
    return int.from_bytes(s.encode(encoding="ascii"), byteorder='little')

def int_to_string(i):
    length = (i.bit_length() + 7) // 8
    return i.to_bytes(length, byteorder='little').decode(encoding="ascii")
```