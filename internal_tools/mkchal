#!/usr/bin/env python3

import os
import sys
import re
import subprocess
import time
import tempfile
import shutil

def get_challenge_name(args):
  tokens = []
  for a in args:
    tokens.extend(re.sub('[^0-9a-zA-Z_\- ]+', '', a).strip().split())

  return '_'.join(tokens)

if __name__ == '__main__':
  # find all the files downloaded in the past 60 seconds
  download_dir = os.path.expanduser('~/Downloads')
  files = set()
  for f in os.listdir(download_dir):
    if time.time() - os.path.getmtime(os.path.join(download_dir, f)) <= 60:
      files.add(os.path.join(download_dir, f))

  # create challenge directory
  chal_name = get_challenge_name(sys.argv[1:])
  shutil.rmtree(chal_name, ignore_errors=True)
  os.mkdir(chal_name)

  with open('%s/README.md' % chal_name, 'w') as f:
    for line in sys.stdin:
      f.write(line)

  for f in files:
    with tempfile.TemporaryDirectory() as tmp_path:
      if f.endswith('.zip'):
        os.system('unzip -d "%s" "%s"' % (tmp_path, f))
      elif f.endswith('.tar.gz') or f.endswith('.tgz'):
        os.system('tar xzvf "%s" -C "%s"' % (f, tmp_path))
      else:
        os.system('mv "%s" "%s"' % (f, chal_name))
        continue

      os.system('rm -rf `find "%s" -name __MACOSX`' % tmp_path)

      final_path = tmp_path
      while True:
        children = os.listdir(final_path)
        if len(children) == 0 or len(children) > 1:
          break

        child_path = os.path.join(final_path, children[0])

        if not os.path.isdir(child_path):
          break

        final_path = child_path

      os.system('mv `find "%s" -name "*" -depth 1` "%s"' % (final_path, chal_name))
      os.remove(f)

  print(chal_name)
  os.system('ls "%s"' % chal_name)
