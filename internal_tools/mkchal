#!/usr/bin/env python3

import os
import sys
import re
import subprocess
import time
import tempfile
import shutil

def is_valid(line):
  if line.strip().lower().startswith('download link'):
    return False

  if re.search('\d+[ \t]+points', line) or re.search('\d+[ \t]+solves', line) or re.search('\d+[ \t]+solve', line):
    return False

  if re.search('\d+pt', line):
    return False

  if line.lower().startswith('points:') or line.lower().startswith('solves:'):
    return False

  if 'points' in line.lower() and 'solves' in line.lower():
    return False

  if line.strip().isnumeric():
    return False

  if all(not l.isalnum() for l in line.strip()):
    return False

  if line.strip().lower() in ['web', 're', 'rev', 'pwn', 'crypto', 'misc', 'tags', 'description', 'cry', 'pts', 'solves']:
    return False

  return True

def get_challenge_name(args):
  tokens = []
  for a in args:
    tokens.extend(re.sub('[^0-9a-zA-Z_\-. ]+', '', a).strip().split())

  return '_'.join(tokens)

if __name__ == '__main__':
  # find all the files downloaded in the past 60 seconds
  download_dir = os.path.expanduser('~/Downloads')
  files = set()
  for f in os.listdir(download_dir):
    if time.time() - os.path.getmtime(os.path.join(download_dir, f)) <= 60:
      files.add(os.path.join(download_dir, f))

  # create challenge directory
  lines = '\n'.join([re.sub(r'(\d+[ \t]+points)', r'\n\1', l.strip()) for l in sys.stdin.readlines()]).strip().split('\n')
  chal_name = get_challenge_name(lines[0].strip().split('/')[-1].strip().split())

  lines = '\n'.join(lines[1:]).strip().split('\n')
  lines = [l for l in lines if is_valid(l)]

  shutil.rmtree(chal_name, ignore_errors=True)
  os.mkdir(chal_name)

  for f in files:
    with tempfile.TemporaryDirectory() as tmp_path:
      if f.endswith('.zip'):
        if os.system('unzip -d "%s" "%s"' % (tmp_path, f)) != 0:
          os.system('mv "%s" "%s"' % (f, chal_name))
          continue
      elif f.endswith('.tar.gz') or f.endswith('.tgz') or f.endswith('.txz'):
        if os.system('tar xzvf "%s" -C "%s"' % (f, tmp_path)) != 0:
          os.system('mv "%s" "%s"' % (f, chal_name))
          continue
      elif f.endswith('.7z'):
        if os.system('7z x "%s" -o"%s"' % (f, tmp_path)) != 0:
          os.system('mv "%s" "%s"' % (f, chal_name))
          continue
      elif f.endswith('.rar'):
        if os.system('unrar x "%s" -op"%s"' % (f, tmp_path)) != 0:
          os.system('mv "%s" "%s"' % (f, chal_name))
          continue
      else:
        os.system('mv "%s" "%s"' % (f, chal_name))
        continue

      os.system('rm -rf `find "%s" -name __MACOSX`' % tmp_path)

      final_path = tmp_path
      while True:
        children = os.listdir(final_path)
        if len(children) == 0 or len(children) > 1:
          break

        child_path = os.path.join(final_path, children[0])

        if not os.path.isdir(child_path):
          break

        final_path = child_path

      os.system('mv `find "%s" -name "*" -depth 1` "%s"' % (final_path, chal_name))
      os.remove(f)

  readme = ''
  if os.path.exists('%s/README.md' % chal_name):
    readme = open('%s/README.md' % chal_name).read()
  readme = '\n'.join(lines[0:]).strip() + '\n' + '\n\n' + readme
  open('%s/README.md' % chal_name, 'w').write(readme.strip() + '\n')

  print('\n\n+++++++++++++++++++++++++++++++++++++++++++++++')
  print(chal_name)
  os.system('ls "%s"' % chal_name)
  print('+++++++++++++++++++++++++++++++++++++++++++++++\n')
  print('\n-----------------------------------------------')
  os.system('cat "%s/README.md"' % chal_name)
  print('-----------------------------------------------\n')
